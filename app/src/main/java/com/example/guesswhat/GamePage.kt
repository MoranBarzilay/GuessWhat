package com.example.guesswhat

import android.content.Context
import android.os.CountDownTimer
import androidx.compose.foundation.layout.*
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp

@Composable
fun GamePage(onBackClick: () -> Unit) {
    val context = LocalContext.current
    val sharedPreferences = context.getSharedPreferences("GameSettings", Context.MODE_PRIVATE)

    // Retrieve saved game settings
    val gameDuration = sharedPreferences.getInt("gameDuration", 60) * 1000L
    val customWords = sharedPreferences.getStringSet("customWords", emptySet())?.toList() ?: listOf()

    val wordList = listOf("מילה","עולם","שולחן","כיסא","ספר","מחברת","עט","עץ","חלון","דלת","בית","גינה","פרח","ילד","ילדה","בית ספר","מחשב","טלפון","שעון","דף","מכונית","סירה","אופניים","כלב","חתול","פרפר","שמש","ירח","כוכב","גשם","רוח","שלג","ענן","מטוס","רכבת","עיפרון","צבע","כדור","כדורגל","משחק","שחקן","קיץ","חורף","סתיו","אביב","לוח","שוקולד","בננה","תפוח","עגבנייה","מלפפון","חסה","סלט","ארוחה","בוקר","צהריים","ערב","לילה","קיר","רצפה","תקרה","קומה","מעלית","מדרגות","יד","רגל","ראש","אוזן","עין","פה","שן","שיער","בגדים","חולצה","מכנסיים","שמלה","נעליים","כובע","גרביים","מעיל","מטרייה","מטר","חצר","גג","קופסה","תיק","מפתח","ספה","טלוויזיה","רדיו","תמונה","מראה","שעון קיר","סיר","מחבת","כף","מזלג","סכין","כוס","צלחת","קערה","תנור","מקרר","מקפיא","מיקרוגל","שולחן אוכל","מיטה","כרית","שמיכה","מגבת","סבון","שמפו","מים","קפה","תה","חלב","יין","בירה","מיץ","קולה","תפוז","קלמנטינה","ענב","תות","מלון","אבטיח","דובדבן","שזיף","אפרסק","מנגו","רימון","גזר","קישוא","פלפל","בטטה","תפו״א","דג","בשר","עוף","גבינה","לחם","פסטה","אורז","קינוח","עוגה","עוגייה","גלידה","פיצה","המבורגר","סושי","פיתה","חומוס","טחינה","לבנה","שוקו","דבש","סוכר","מלח","פלפל שחור","קמח","שמן","חמאה","חציל","ברוקולי","כרוב","כרובית","פטריות","תרד","זיתים","זנגביל","קינמון","וניל","אגוז","שקד","אגוז מלך","אגוזי לוז","פיסטוק","שקדים","קקאו","סוכריות","מסטיק","גז","חשמל","אור","נר","גפרור","אש","מים רותחים","דלי","מטאטא","מגב","סמרטוט","מדיח","מכונת כביסה","מייבש","אבקת כביסה","סבון כלים","גינה ציבורית","חוף ים","גשר","כביש","רמזור","תמרור","מכונת קפה","שקע חשמל","מטען","סוללה","מזגן","מאוורר","מחסן","חנייה","רכב","מונית","אוטובוס","אופנוע","קטנוע","קורקינט","טרקטורון","מנוף","מסוק","אונייה","משאית","אופניים חשמליים","קרטון","פלסטיק","פחית","בקבוק","זכוכית","בלון","חוט","דבק","מספריים","מחט","כפתור","רוכסן","חולצת טריקו","ז'קט","ג'ינס","חליפה","עניבה","כפפות","מגפיים","סנדלים","טבעת","שרשרת","צמיד","עגילים","משקפיים","משקפי שמש","מצלמה","מיקרופון","רמקול","מדפסת","סורק","טאבלט","טאבלט גרפי","דינוזאור","רובוט","חללית","אסטרונאוט","לוויין","מדען","חוק","שוטר","כבאי","רופא","אחות","טבח","אופה","מהנדס","מתכנת","צייר","פסל","סופר","משורר","שחקן תיאטרון","זמר","חקלאי","נגר","בנאי","מתווך","חשמלאי","אינסטלטור","נהג","מדריך","מורה","פרופסור","שופט","עורך דין","סוכן ביטוח","סוכן נדל״ן","רואה חשבון","חוקר פרטי","קוסם","לוליין","צוללן","גולש","סקיפר","דייג","טייס","אדריכל","מאמן","שחקן כדורגל","שחקן כדורסל","שחקן טניס","שחקן שחמט","מתאגרף","רץ","קופץ","שחיין","רוכב סוסים","נהג מירוצים","שמיים","אדמה","כוכבים","ירח","שמשיה","דשא","דבורים","ציפור","גדר","גזע","זאב","אריה","פיל","ג'ירפה","קוף","צב","עקרב","נמר","זברה","חמור","סוס","כבשה","פרה","תרנגול","ציפורן","עלה","שורש","פרח","גבעול","יער","מדבר","נהר","נחל","אגם","מפל","סלע","חצץ","קרח","קרחון","מעיין","ביצה","נמרוד","מצרים","ירדן","סוריה","לבנון","תל אביב","חיפה","ירושלים","נצרת","באר שבע","אילת","ים","ים תיכון","הכנרת","ים המלח","ים סוף","מרחק","זמן","שעון מעורר","קפה קר","קפה שחור","קפה הפוך","אייס קפה","מים מינרלים","סודה","יוגורט","גבינת קוטג'","גבינת צהובה","חמאה","קמח מלא","סוכר חום","אורז מלא","תפו״א מתוק","תירס","עוף בגריל","סושי צמחוני","פסטה ברוטב שמנת","פיצה מרגריטה","פוקצ'ה","בורקס גבינה","מלוואח","ג'חנון","שקשוקה","חביתה","חלה","סלט ירקות","עגבניות שרי","פטריות שמפיניון","קציצות בשר","קבב","שניצל","טחינה גולמית","פיתה עיראקית","לאפה","זיתים שחורים","זיתים ירוקים","חמוצים","פרגית","קוסקוס","חמין","פלאפל","מרק ירקות","מרק עוף","נזיד","אורז לבן","תבשיל שעועית","מוקפץ","קינואה","טורטייה","קרואסון","בלינצ'ס","ספינג'","גולאש","קבבונים","קלמרי","סלט קינואה","קרם ברולה","פנקייק","ופל בלגי","סופלה שוקולד","טירמיסו","גבינת מסקרפונה","גבינת עיזים","גבינת מוצרלה","גבינת פרמזן","גבינת רוקפור","גבינת אמנטל","גבינת בולגרית","סביח","חצילים מטוגנים","חצילים אפויים","פיצה ארבע גבינות","קציפת פירות","גלידת וניל","גלידת שוקולד","סורבה פירות","ברד לימונענע","גזוז תות","לימונדה","שוקו חם","סיידר תפוחים","סיידר קר","מיץ גזר","מיץ תפוזים סחוט","גזרים","תפו״א","סלק","לפת","דלעת","דלורית","בטטה","דובדבנים","תותי עץ","פירות יער","פטל","ענבים ירוקים","תפוח עץ ירוק","מנדרינה","אשכולית אדומה","שזיף צהוב","אפרסמון","רימונים","תאנים","תמרים","חרובים","שקדיות","עצי זית","תאנה","ברוש","אורן","ארז","אלון","אקליפטוס","דקל","תמר","פרדס","כרם","חממה","משק חקלאי","לול","דיר","רפת","חווה","מחלבה","מטע","גפן","שדה","חיטה","שעורה","תירס מתוק","קני סוכר","עגבניות","מלפפונים חמוצים","עוף בתנור","בשר כבש","בשר בקר","סטייק אנטריקוט","צלעות טלה","אסאדו","נקניקיות עגל","פסטרמה","שווארמה","המבורגר צמחוני","תבשיל בשר","גולש הונגרי","מנסף","טאג'ין מרוקאי","מפרום","תבשיל כבד עוף","עוף בטטות","אורז ירוק","תפוחי אדמה מוקרמים","פלפלים ממולאים","קישואים ממולאים","כרובית מטוגנת","ברוקולי אפוי","פסטה עם רוטב עגבניות","רביולי גבינה","רביולי תרד","ניוקי","לזניה","פיצה פפרוני","קלצונה","סופגניות","אזני המן","רוגלעך","בורמוליקוס","קוגל","קיגל תפוחי אדמה","פשטידת תירס","פשטידת פטריות","טארט טאטן","פאי תפוחים","עוגת גבינה אפויה","עוגת שוקולד","עוגת גזר","עוגת ביסקוויטים","סופגניה","פנקייק","פאי לימון","מילפיי","קרם בוואריה","מרקם","מתכון","חמצן","חנקן","פחמן","כלור","יוד","אוזון","אמוניה","נתרן","נחושת","אלומיניום","ברזל","ניקל","טיטניום","עופרת","זהב","כסף","יהלום","פנינה","אלמוג","דולפין","כריש","לוויתן","צלופח","תנין","צב ים","נחש","נץ","עיט","ציפור שיר","גוזל","ביצה","אפרוח","ברווז","אווז","פלמינגו","שקנאי","אנפה","חסידה","יונה","עורב","נשר","ינשוף","סנונית","דרור","קיכלי","עורבני","בולבול","שחרור","חוחית","פשוש","סבכי","שחף","שחפית","צוללן","יסעור","פרופלור","מנוע","דחפור","מנוף","מלגזה","משאית","אוטובוס","אופנוע ים","טרקטור","ג'יפ","רכב שטח","קטר","קרון","מכולה","מזוודה","שקית","כיס","גרב","שרוך","שרשרת זהב","עגילי יהלום","טבעת אירוסין") + customWords
    var timer by remember { mutableStateOf(gameDuration / 1000) }
    var currentWord by remember { mutableStateOf(wordList.random()) }
    var score by remember { mutableStateOf(0) }
    var gameOver by remember { mutableStateOf(false) }  // State to track if the game is over
    var restartTimer by remember { mutableStateOf(false) } // State to track if the timer should restart

    // Start the timer and restart it when gameOver or restartTimer changes
    LaunchedEffect(gameOver, restartTimer) {
        if (!gameOver) {
            object : CountDownTimer(gameDuration, 1000) {
                override fun onTick(millisUntilFinished: Long) {
                    timer = millisUntilFinished / 1000
                }

                override fun onFinish() {
                    gameOver = true
                }
            }.start()
        }
    }

    Column(
        modifier = Modifier.fillMaxSize(),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        if (!gameOver) {
            // Display the timer
            Text(text = "זמן: $timer שניות")
            Spacer(modifier = Modifier.height(16.dp))

            // Display the current word
            Text(text = currentWord)
            Spacer(modifier = Modifier.height(16.dp))

            // V button (Increase score and get new word) with green color
            Row {
                // X button (Skip word and get new word) with red color
                Button(
                    onClick = {
                        currentWord = wordList.random()
                    },
                    colors = ButtonDefaults.buttonColors(
                        containerColor = Color.Red // Setting the button color to red
                    )
                ) {
                    Text("X")
                }

                Spacer(modifier = Modifier.width(16.dp))

                Button(
                    onClick = {
                        score++
                        currentWord = wordList.random()
                    },
                    colors = ButtonDefaults.buttonColors(
                        containerColor = Color.Green // Setting the button color to green
                    )
                ) {
                    Text("V")
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // Back Button to return to the main page
            Button(onClick = onBackClick) {
                Text("חזרה לעמוד הראשי")
            }

        } else {
            // Display the result when the game is over
            Text(text = "נגמר הזמן!")
            Spacer(modifier = Modifier.height(16.dp))
            Text(text = "הניקוד שלכם: $score")
            Spacer(modifier = Modifier.height(250.dp))

            // Play Again Button (reset the game)
            Button(onClick = {
                score = 0
                currentWord = wordList.random()
                timer = gameDuration / 1000
                gameOver = false  // Restart the game
                restartTimer = !restartTimer // This will restart the timer
            }) {
                Text("שחק שוב")
            }

            Spacer(modifier = Modifier.height(16.dp))

            // Return to Main Page button
            Button(onClick = onBackClick) {
                Text("חזרה לעמוד הראשי")
            }
        }
    }
}